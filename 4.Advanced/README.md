# 🎣Advanced編：AI エージェント🤖 を作ってみる

[3.RAG](/3.RAG/) では、以下の動作を個別に確認しました。

- 🎣 釣った魚の魚名がわからない！　→　ベクトル検索を利用して魚名 Get！
- 🎣 釣った魚のローカルレシピを知りたい！ →　得られた魚名＋釣り場情報をIRISから入手し補足情報として追加し、生成AIにレシピ生成依頼！

例えば、釣り人ビギナーが、**「釣った魚の名前はわからないけれど、地元料理のレシピが知りたい」** のように、2 つの事を 1 度に要求するかもしれません。

また、釣り場が用意する釣果登録データベースにその日の成果を登録できる処理を用意した場合は、釣り人から **「釣果登録がしたい」** と依頼が来るかもしれません。

釣り人から来る更なるリクエストに対応するため、今までの処理を組み合わせて**エージェント**として実行できるように改良を加えていきます🤖。

<br>
では、どのように改良していくと良いでしょうか？
<br>
<br>
今まで作成した処理は、Colab 上で**関数**として実装しています。

これら関数には、引数、戻り値の**仕様**や**実行順**があります。

これら情報を、AI が理解できれば、🎣釣り人からの依頼に対して何を最初に実行したらいいのか、🎣釣り人から何の情報を入手したら実行できるのか、を教えてくれるはずです！🤖

といことで、Advanced編では、この流れを OpenAI が提供する openai パッケージにある [Chat Completions API](https://platform.openai.com/docs/api-reference/chat) の [Function calling](https://platform.openai.com/docs/guides/function-calling?api-mode=chat) を使って実装してみます（`Tool calling` とも呼ぶそうです）。


## 動作の仕組み

仕組みの中で使用する用語について、🎣釣り人ビギナーサポートAI で作成した関数と照らし合わせてご紹介します。

> 詳細は [Function calling](https://platform.openai.com/docs/guides/function-calling?api-mode=chat) をご参照ください。

- Tools（モデルに与える機能）

    関数またはツールは、モデルにアクセスを許可する機能で、
    具体的には、モデルに次のようなツールへのアクセス権を与えることができます。
    
    - 魚の画像から魚名を取得する（例：get_fishname）
    - 釣った魚と釣り場にちなんだレシピを生成する（例：get_recipe）
    - 釣った魚の釣果登録（例：choka）

    モデルがプロンプトに対して応答するとき、これらのツールをモデルに知っておいて欲しい場合、プロンプトと一緒に「ツールのリスト」を含めて送付することができます。

    例えば、プロンプトに「釣った魚の名前がわからないけど釣果登録がしたい」を送ると同時に、上記ツールのリスト（get_fishname、get_recipe、choka）を送付することで、モデルがこれらツールの存在を知り、プロンプトの内容に合わせて適切なツールを選び、アクセスの許可を応答として返します。

- Tool calls（モデルからのツール使用リクエスト）

    関数呼び出し、またはツール呼び出しと呼ばれています。

    モデルに「ツールリスト」を送付している場合、モデルが提供されているツールの1つを呼び出す必要があると判断した場合、特別な種類の応答を返します。

    応答の例： 「釣った魚の名前がわからないけど釣果登録がしたい」のプロンプトをモデルが受信した場合、「釣った魚の名前」を調べるため `釣った魚の画像ファイル` を引数とする `get_fishname` ツールの呼び出しを返します。

- Tool call outputs（モデル向けに生成する出力）

    関数、またはツール呼び出しの出力は、モデルの応答に含まれているツールを実行したときに生成された応答の事をさします。

    例えば、「釣った魚の名前がわからないけど釣果登録がしたい」のプロンプトをモデルが受信した場合、「釣った魚の名前」を調べるため `釣った魚の画像ファイル` を引数とする `get_fishname` ツールの呼び出しを返し、アプリケーションがツールを実行した後、`{"FishID":"f001","FishName":"マアジ"}` などのJSONを応答として生成します（この応答の事をさします）。

## ツール呼び出しのフロー
ツール呼び出しは、OpenAI APIを介してアプリケーションとモデル間で行われる複数ステップのやり取りです。ツール呼び出しフローは、大きく分けて5つのステップに分かれています。

- [1]モデルにツールリストを含めてリクエストする
- [2]モデルからのツール呼び出しを受信する
- [3]ツール呼び出しからの入力を使用してアプリケーション側でコードを実行する
- [4]ツールの出力を使用してモデルに2回目のリクエストを送信する
- [5]モデルからの最終応答（またはそれ以上のツール呼び出し）を受信する

例）🎣釣った魚の名前がわからないけど釣果登録がしたい をプロンプトとして送った場合

![](/assets/4.Advanced-flow.jpg)

この後は、実際のコードを確認しながら進めます。

ファイル：[FishermanBeginerSupportAgent.ipynb](/4.Advanced/FishermanBeginerSupportAgent.ipynb) を Googleドライブにコピーして、Colabで実行してみましょう！🤖