Class Sample.RESTCOMPLETEVER Extends %CSP.REST
{

Parameter CONTENTTYPE = "application/json";

Parameter CHARSET = "utf-8";

Parameter CONVERTINPUTSTREAM = 1;

Property key As %String(MAXLEN = "");

XData UrlMap [ XMLNamespace = "http://www.intersystems.com/urlmap" ]
{
<Routes>
<Route Url="/recipe" Method="POST" Call="recipe" Cors="true"/>
<Route Url="/recipe2" Method="POST" Call="recipe2" Cors="true"/>
<Route Url="/upload" Method="POST" Call="upload" Cors="true"/>
<Route Url="/choka" Method="POST" Call="choka" Cors="true"/>
<Route Url="/hello" Method="GET" Call="hello" Cors="true"/>
</Routes>
}

/// é­šã®ç”»åƒã¯fishã§é€ã‚‹
ClassMethod upload() As %Status
{
    #dim %request As %CSP.Request
    /* === basepath ã‚’å¤‰æ›´ã—ã¾ã™ ===
        ğŸŸç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼
        basepath ã¯ ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—ç”¨ã«ä½œæˆã•ã‚ŒãŸãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä»¥ä¸‹ã®ä»»æ„ã«ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã—ã¾ã™ã€‚
        ãƒ•ãƒ«ãƒ‘ã‚¹ã§æŒ‡å®šã—ã¦ãã ã•ã„ã€‚
    =========================== */
    set basepath="/src/images/"
    set basepath=##class(%File).NormalizeDirectory(basepath)

    set upstream=$get(%request.MimeData("fish", 1))
    set fname=%request.MimeData("fish",1).FileName
    set fo=##class(%Stream.FileBinary).%New()
    do fo.LinkToFile(basepath_fname)
    do fo.CopyFrom(upstream)
    set status=fo.%Save()
    if $$$ISERR(status) {
        // ãƒ•ã‚¡ã‚¤ãƒ«ä¿å­˜å¤±æ•—
        return status
    }
    //ç”»åƒã®Embedding
    set embed=##class(MeetUp2025.Event).GetEmbedding("I",basepath_fname)
    //ãƒ™ã‚¯ãƒˆãƒ«æ¤œç´¢
    set sql="select top 1 FishID,Name,VECTOR_COSINE(Features, TO_VECTOR(?, DOUBLE, 512)) as cos from MeetUp2025.Fish ORDER BY cos desc"    set stmt=##class(%SQL.Statement).%New()
    set status=stmt.%Prepare(sql)
    set rset=stmt.%Execute(embed)
    do rset.%Next()

    //ã€€JSONä½œæˆ
    set json={}
    set json.FishID=rset.%Get("FishID")
    set json.FishName=rset.%Get("Name")
    do json.%ToJSON()
    return $$$OK
}

/// é‡£æœç™»éŒ²
/// SpotIDã¯å›ºå®šï¼štb-001
/// Body
/// {
///  "FishID":"f001",
///  "FishName":"ã‚¢ã‚¸",
///  "Size":20,
///  "FishCount": 2
/// }
ClassMethod choka() As %Status
{
    #dim %request As %CSP.Request
    set body={}.%FromJSON(%request.Content)
    set sql="insert into MeetUp2025.FishingInfo (SpotID,FishID,ReportDate,Size,FishCount) VALUES(?,?,?,?,?)"
    set stmt=##class(%SQL.Statement).%New()
    set status=stmt.%Prepare(sql)
    set stmt.%SelectMode=1
    set rset=stmt.%Execute("tb-001",body.FishID,$ZDATE($H,3),body.Size,body.FishCount)
    set j={}
    set j.Message=body.FishName_"ã®é‡£æœç™»éŒ²å®Œäº†"
    do j.%ToJSON()
    return $$$OK
}

/// Ollamaç”¨
/// POSTã®ãƒœãƒ‡ã‚£
/// {
///  "FishID":"f001",
///  "FishName":"é­šå",
///  "UserInput":"å¸Œæœ›ã®ãƒ¬ã‚·ãƒ”ã®å†…å®¹"
/// }
/// é­šåã‹ã‚‰FishIDã‚’å…¥æ‰‹ã—ã€ãã®é­šã®éå»2å¹´é–“ã®é‡£æœæƒ…å ±ã¨é‡£ã‚Šå ´ã®æ½®ä½æƒ…å ±ã‚’å…¥æ‰‹ã—ç”ŸæˆAIã«æ¸¡ã™
ClassMethod recipe() As %Status
{
    #dim %request As %CSP.Request
    set body={}.%FromJSON(%request.Content)
    // ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã®é­šåã‹ã‚‰ç”ŸæˆAIã«æ¸¡ã™è£œè¶³æƒ…å ±ã‚’å…¥æ‰‹ã™ã‚‹
    // bodyã®JSONã« "FishInfo" ãŒè¿½åŠ ã•ã‚Œã‚‹
    set status=..GetFishInfo(.body)
    set status=..AskLLM(1,.body,.ans)
    do ans.%ToJSON()
    return $$$OK
}

/// OpenAIç”¨
/// POSTã®ãƒœãƒ‡ã‚£
/// {
///  "FishID":"f001",
///  "FishName":"é­šå",
///  "UserInput":"å¸Œæœ›ã®ãƒ¬ã‚·ãƒ”ã®å†…å®¹"
/// }
/// é­šåã‹ã‚‰FishIDã‚’å…¥æ‰‹ã—ã€ãã®é­šã®éå»2å¹´é–“ã®é‡£æœæƒ…å ±ã¨é‡£ã‚Šå ´ã®æ½®ä½æƒ…å ±ã‚’å…¥æ‰‹ã—ç”ŸæˆAIã«æ¸¡ã™
ClassMethod recipe2() As %Status
{
    #dim %request As %CSP.Request
    set body={}.%FromJSON(%request.Content)
    // ãƒ¦ãƒ¼ã‚¶å…¥åŠ›ã®é­šåã‹ã‚‰ç”ŸæˆAIã«æ¸¡ã™è£œè¶³æƒ…å ±ã‚’å…¥æ‰‹ã™ã‚‹
    // bodyã®JSONã« "FishInfo" ãŒè¿½åŠ ã•ã‚Œã‚‹
    set status=..GetFishInfo(.body)
    set status=..AskLLM(0,.body,.ans)
    do ans.%ToJSON()
    return $$$OK
}

ClassMethod GetFishInfo(ByRef body As %DynamicArray) As %Status
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    try {
        set stmt=##class(%SQL.Statement).%New()
        set fishid=body.FishID

        // é‡£ã‚Šå ´ã®æƒ…å ±ã‚’å–å¾—ï¼ˆæœ¨æ›´æ´¥æ²–å ¤é˜²å›ºå®šæƒ…å ±ï¼šSpotID='tb-001'ï¼‰
        set sql2="SELECT SpotName||'ã®çŠ¶æ³ã¯ã€'||TideState||'ã€'|| TideCycle||'ã€æ½®ä½ã¯'||TideHeightCmRelative||'cm' as result ,SpotID,DatetimeJst"
        set sql2=sql2_" FROM MeetUp2025.BayInfo WHERE SpotID='tb-001' AND DatetimeJst BETWEEN DATEADD(hour,-1,?) AND ?"
        // ç¾åœ¨ã®ãƒ­ãƒ¼ã‚«ãƒ«ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—
        set ts=##class(%UTC).NowLocal()
        set stmt.%SelectMode=1  //ODBCãƒ¢ãƒ¼ãƒ‰
        $$$ThrowOnError(stmt.%Prepare(sql2))
        set rset=stmt.%Execute(ts,ts)
        do rset.%Next()
        set result=rset.%Get("result")
        //ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç¯„å›²å¤–ã®å ´åˆã®å¯¾å¿œï¼ˆæ½®ä½ãƒ‡ãƒ¼ã‚¿ã¯2026/9/9ã¾ã§ï¼‰
        if result="" {
            set spotinfo=rset.DatetimeJst_" â˜…ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç¯„å›²å¤–ã®ãŸã‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”é€â˜… é‡£ã‚Šå ´ï¼šæœ¨æ›´æ´¥æ²–å ¤é˜² ä¸‹ã’æ½®ã€è‹¥æ½®ã€æ½®ä½ã¯28.5cm"  
        }
        else {
            set spotinfo=rset.DatetimeJst_" é‡£ã‚Šå ´ï¼š"_result
        }

        // éå»ã®é‡£ã‚Šæƒ…å ±ï¼ˆæœ¨æ›´æ´¥æ²–å ¤é˜²å›ºå®šæƒ…å ±ï¼šSpotID='tb-001'ï¼‰
        // éå»2å¹´ã€æŒ‡å®šæ—¥ä»˜ã®æœˆå‰å¾Œ1ã‹æœˆã®é‡£ã‚Šæƒ…å ±
        set sql3="SELECT 'æœ€å¤§æ•°:'||MAX(FishCount)||'ã€æœ€å°æ•°:'||MIN(FishCount)||'ã€æœ€å¤§é•·cm:'||MAX(Size)||'ã€æœ€å°é•·cm:'||MIN(Size) as result"
        set sql3=sql3_" FROM MeetUp2025.FishingInfo WHERE FishID=? AND SpotID='tb-001' AND (ReportDate >= DATEADD(yyyy,-2,?) AND (DATEPART(mm,ReportDate) BETWEEN DATEPART(mm,?)-1 AND DATEPART(mm,?)+1))"
        $$$ThrowOnError(stmt.%Prepare(sql3))
        set now=$ZDATE($Horolog,3)
        set rset=stmt.%Execute(fishid,now,now,now)
        do rset.%Next()
        set fishinginfo=rset.%Get("result")
        set body.FishInfo=$Get(spotinfo)

        if $GET(fishinginfo)'="" {
            set body.FishInfo=$Get(spotinfo)_"ã€€æœ¬æ—¥ã®å‰å¾Œ1ã‹æœˆã®éå»2å¹´é–“ã®é‡£æœæƒ…å ±ã¯ã€"_$Get(fishinginfo)
        }
        else {
            //ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç¯„å›²å¤–ã®å ´åˆãƒ€ãƒŸãƒ¼ã‚’ã‚»ãƒƒãƒˆ     
            set body.FishInfo=$Get(spotinfo)_"ã€€æœ¬æ—¥ã®å‰å¾Œ1ã‹æœˆã®éå»2å¹´é–“ã®é‡£æœæƒ…å ±ã¯ã€â˜…ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ç¯„å›²å¤–ã®ãŸã‚ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’è¿”é€â˜… æœ€å¤§æ•°:115ã€æœ€å°æ•°:1ã€æœ€å¤§é•·cm:87ã€æœ€å°é•·cm:8"
        }
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

ClassMethod hello() As %Status
{
    set json={}
    set json.RetMessage="ã‚ã„ã†ãˆãŠ"
    do json.%ToJSON()
    return $$$OK
}

ClassMethod AskLLM(flg As %Boolean = 1, body As %DynamicAbstractObject, ByRef ans As %DynamicAbstractObject) As %DynamicAbstractObject
{
    #dim ex As %Exception.AbstractException
    set status=$$$OK
    set ans={}
    set ans.Message=""
    try {
        //é€ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æº–å‚™
        set sendjson={}
        set sendjson.messages=[]
        set prompt={}
        set prompt.role="system"
        set prompt.content="ã‚ãªãŸã¯é‡£ã‚Šå ´ã«ã¡ãªã‚“ã åœ°å…ƒã®é­šæ–™ç†ã‚’ã‚ˆãçŸ¥ã‚‹ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚åœ°å…ƒåã¯ fishinfo: ä»¥é™ã«è¨˜è¼‰ã®ã‚ã‚‹é‡£ã‚Šå ´ã®åç§°ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚ä¾é ¼ã®ã‚ã£ãŸãƒ¬ã‚·ãƒ”ã‚’250æ–‡å­—ç¨‹åº¦ã«è¦ç´„ã—ã¦å›ç­”ã—ã¦ãã ã•ã„ã€‚"
        do sendjson.messages.%Push(prompt)
        set prompt={}
        set prompt.role="system"
        set prompt.content="é­šåã¯"_body.FishName_"ã€‚fishinfo:"_body.FishInfo
        do sendjson.messages.%Push(prompt)
        set prompt={}
        /* === prompt.contet ã«UserInputã®å†…å®¹ã‚’è¨­å®šã—ã¾ã™*/
        set prompt.role="user"
        set prompt.content=body.UserInput
        do sendjson.messages.%Push(prompt)
        //request
        set req=##class(%Net.HttpRequest).%New()
        set req.ContentType="application/json"
        set req.ContentCharset="utf-8"

        /*LLMæ¯ã®æº–å‚™*/
        // Ollama
        /* === req.Server ã‚’å¤‰æ›´ã—ã¾ã™ ===
            ğŸŸç’°å¢ƒã«åˆã‚ã›ã¦å¤‰æ›´ã—ã¦ãã ã•ã„ï¼
            LLMã®IPã‚¢ãƒ‰ãƒ¬ã‚¹ã¯ãƒ¯ãƒ¼ã‚¯ã‚·ãƒ§ãƒƒãƒ—å½“æ—¥ã«å…¬é–‹ã—ã¾ã™ã€‚
            å®Ÿè¡Œå‰ã«å¿…ãšå¤‰æ›´ã—ã¦ãã ã•ã„ï¼
        =========================== */        
        if flg=1 {
            set req.Server="13.115.186.166"
            set req.Location="/api/chat"
            //ãƒ¢ãƒ‡ãƒ«ã®æŒ‡å®š
            set sendjson.model="hf.co/mmnga/ELYZA-Shortcut-1.0-Qwen-7B-gguf:q4_k_m"
            do sendjson.%Set("stream",0,"boolean")
            set options={}
            set options."num_gpu"=999
            set options."num_ctx"=2048
            set options."num_thread"=8
            set options."num_predict"=256
            set sendjson.options=options
        }
        // OpenAI
        if flg'=1 {
            set req.Server="api.openai.com"
            set req.Location="/v1/chat/completions"
            //ãƒ¢ãƒ‡ãƒ«ã®æŒ‡å®š
            set sendjson.model="gpt-4o"
            set key=..setAPIKey()
            //httpsé€šä¿¡ç”¨æŒ‡å®š
            set req.SSLConfiguration="webapi"
            set req.Https=1
            //APIã‚­ãƒ¼ã®ã‚»ãƒƒãƒˆ
            do req.SetHeader("Authorization","Bearer "_key)
        }
        //body
        do sendjson.%ToJSON(req.EntityBody)
        //w req.EntityBody.Read(),!
        //w w req.EntityBody.Rewind()

        $$$ThrowOnError(req.Post())
        set response=req.HttpResponse
        if response.StatusCode'=200&(response.StatusCode'=202) {
            set errmessage=response.Data.Read()
            set status=$system.Status.Error(5001,errmessage)
            return status
        }

        set resjson={}.%FromJSON(response.Data)
        /* LLMæ¯å›ç­”ãŒç•°ãªã‚‹*/
        //Ollama
        if flg=1 {
            set ans.Message=resjson.message.content
        }
        //OpenAI
        if flg'=1 {
            set ans.Message=resjson.choices."0".message.content   
        }
        set ans.FishInfo=body.FishInfo
    }
    catch ex {
        set status=ex.AsStatus()
    }
    return status
}

/// /src/wsgi/config.pyã«è¨˜è¼‰ã—ã¦ã„ã‚‹OpenAIã®APIã‚­ãƒ¼ã‚’å…¥æ‰‹ã—ã¦æˆ»ã™
ClassMethod setAPIKey() As %String(MAXLEN="")
{
    set sys=##class(%SYS.Python).Import("sys")
    do sys.path.append("/src/wsgi")
    set config=##class(%SYS.Python).Import("config")
    return config.key
}

ClassMethod setdata(body As %DynamicAbstractObject) As %DynamicAbstractObject
{
        set sendjson={}
        set sendjson.messages=[]
        set prompt={}
        set prompt.role="system"
        set prompt.content="ã‚ãªãŸã¯é‡£ã‚Šã®ã‚¹ãƒšã‚·ãƒ£ãƒªã‚¹ãƒˆã§é‡£ã‚Šå ´ã®åœ°å…ƒæ–™ç†ã‚’ã‚ˆãçŸ¥ã£ã¦ã„ã¾ã™ã€‚æœ¬æ—¥é‡£ã£ãŸé­šåã€ä½“é•·ã€ãƒ¦ãƒ¼ã‚¶ã®çŠ¶æ³ã€éå»ã®é‡£æœæƒ…å ±ã‚’å‚è€ƒæƒ…å ±ã¨ã—ã¦30åˆ†ç¨‹åº¦ã§ä½œã‚Œã‚‹åœ°å…ƒãƒ¬ã‚·ãƒ”ã‚’æ•™ãˆã¦ãã ã•ã„ã€‚"
        do sendjson.messages.%Push(prompt)
        set prompt={}
        set prompt.role="user"
        set prompt.contet="é­šåã¯"_body.FishName_"ã€‚"_body.FishInfo
        do sendjson.messages.%Push(prompt)
        set prompt={}
        set prompt.role="user"
        set prompt.content=body.UserInput
        do sendjson.messages.%Push(prompt)
        //request
        set req=##class(%Net.HttpRequest).%New()
        set req.ContentType="application/json"
        set req.ContentCharset="utf-8"
        //body
        do sendjson.%ToJSON(req.EntityBody)
        do sendjson.%ToJSON()
        return sendjson
}

}
